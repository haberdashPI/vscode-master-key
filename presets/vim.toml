#:master-keybindings

## # Vim Bindings

## This VIM binding set serves as a starting place to define your own bindings using Master
## Key. Rather than being a comprehensive implementation of VIM it aims to be instructional.
## Users seeking Vim parity should consider vscode-neovim or VSCodeVim. The selected binding
## set was pulled from the MIT licenced bindings located at https://vim.rtorr.com/. When you
## are ready to revise the bindings for your own needs, you can call `Master Key: New
## Keybinding Copy` to edit a copy of these bindings.

[header]
name = "Vim"
version = "2.1.0"
requiredExtensions = [
    "haberdashPI.vscode-select-by-indent",
    "haberdashPI.selection-utilities",
    "pustelto.bracketeer",
    "wmaurer.change-case",
]

[[mode]]
name = "insert"
whenNoBinding = "insertCharacters"

[[mode]]
name = "normal"
default = true
cursorShape = "Block"

[[mode]]
name = "visual"
cursorShape = "Block"

## Normal mode is the default mode in VIM. In this mode each key issues a command,
## even when there is no modifier like control. To insert text you issue
## an insert command (like `i`), see [Insert Mode](#insert-mode) for more ways
## to insert text.

[[bind]]
foreach.key = ["escape", "ctrl+["]
key = "{{key}}"
mode = '{{all_modes()}}'
command = "runCommands"
args.commands = [
    "cancelSelection",
    { command = "master-key.setMode", args = { value = "normal" } },
]
doc.name = "exit"
doc.description = "exit insert/visual mode"
doc.combined.name = "exit"
doc.combined.key = "Esc/Ctrl+["
doc.combined.description = "exit insert/visual mode"

# =============================================================================
## ## Cursor Movement (Normal, Visual, Operator)
# =============================================================================

# -- Templates for Motions --

[[define.val]]
operatorCount = 0
operatorPrefixes = ["d", "y", "c"]

[[define.bind]]
id = "motion"
foreach.item = ['''{{[
    #{mode: "normal", operator: false},
    #{mode: "normal", operator: true},
    #{mode: "visual", operator: false},
]}}''']
mode = '{{item.mode}}'
prefixes.anyOf = '{{ if item.operator { val.operatorPrefixes } else { [""] } }}'
when = '{{ if item.operator { "master-key.val.operatorCount > 0" } else { "true" } }}'

[[define.bind.after]]
skipWhen = '{{!item.operator}}'
command = "master-key.executeStoredCommand"
args.register = "op"

[[define.bind.after]]
skipWhen = '{{!item.operator}}'
command = "master-key.enterNormal"

[[define.bind.after]]
skipWhen = '{{!item.operator}}'
command = "master-key.setValue"
args.name = "operatorCount"
args.value = 0

[[define.bind]]
id = "cursor_motion"
default = "{{bind.motion}}"
command = "cursorMove"
args.value = '{{max(val.operatorCount, 1) * max(key.count, 1)}}'
args.select = '{{mode != "normal"}}'

# -- h, j, k, l --

# h
[[bind]]
default = "{{bind.cursor_motion}}"
key = "h"
args.to = "left"
doc.name = "←"
doc.description = "move cursor left"
doc.combined.name = "←/→"
doc.combined.key = "h/l"
doc.combined.description = "move cursor left/right"

# l
[[bind]]
default = "{{bind.cursor_motion}}"
key = "l"
doc.name = "→"
doc.description = "move cursor right"
doc.combined.name = "←/→"

[[bind.args.commands]]
args.to = "right"

# j
[[bind]]
default = "{{bind.cursor_motion}}"
key = "j"
args.to = "down"
args.by = "wrappedLine"
doc.name = "↓"
doc.description = "move cursor down"
doc.combined.name = "↓/↑"
doc.combined.key = "j/k"
doc.combined.description = "move cursor down/up"

# k
[[bind]]
default = "{{bind.cursor_motion}}"
key = "k"
args.to = "up"
args.by = "wrappedLine"
doc.name = "↑"
doc.description = "move cursor up"
doc.combined.name = "↓/↑"

[[bind]]
default = "{{bind.cursor_motion}}"
key = "g j"
args.by = "line"
args.to = "down"
doc.name = "↓ wrap"
doc.description = "move cursor down (multi-line text)"
doc.combined.name = "↓/↑ wrap"
doc.combined.key = "gj/gk"
doc.combined.description = "move cursor down/up (multi-line text)"

[[bind]]
default = "{{bind.cursor_motion}}"
key = "g k"
args.by = "line"
args.to = "up"
doc.name = "↑ wrap"
doc.description = "move cursor up (multi-line text)"
doc.combined.name = "↓/↑ wrap"

# -- Word Motions (w, W, e, E, b, B) --

[[define.bind]]
id = "object_motion"
default = '{{bind.motion}}'
command = "selection-utilities.moveBy"
args.value = '{{max(key.count, 1) * max(val.opCount, 1)}}'

# w (start of word)
[[bind]]
default = "{{bind.object_motion}}"
key = "w"
args.unit = "subword"
args.boundary = "start"
doc.name = "word →"
doc.description = "jump forwards to the start of a word"
doc.combined.name = "word →/←"
doc.combined.key = "w/b"
doc.combined.description = "jump forwards/backwards to the start of a word"

# b (back start of word)
[[bind]]
default = '{{bind.object_motion}}'
key = "b"
args.unit = "subword"
args.boundary = "start"
args.value = '{{-1 * max(val.opCount,1) * max(key.count, 1)}}'
doc.name = "word ←"
doc.description = "jump backwards to the start of a word"
doc.combined.name = "word →/←"

# W (start of WORD)
[[bind]]
default = "{{bind.object_motion}}"
key = "shift+w"
args.unit = "BigWord"
args.boundary = "start"
doc.name = "WORD →"
doc.description = "jump forwards to the start of a word (words can contain punctuation)"
doc.combined.name = "WORD →/←"
doc.combined.key = "shift+w/shift+b"
doc.combined.description = "jump forwards/backwards to the start of a word (words can contain punctuation)"

# B (back start of WORD)
[[bind]]
default = '{{bind.object_motion}}'
key = "shift+b"
args.unit = "BigWord"
args.boundary = "start"
args.value = '{{-1 * max(val.opCount,1) * max(key.count, 1)}}'
doc.name = "WORD ←"
doc.description = "jump backwards to the start of a word (including punctuation)"
doc.combined.name = "WORD →/←"
doc.combined.key = "shift+w/shift+b"

# e (end of word)
[[bind]]
default = '{{bind.object_motion}}'
key = "e"
args.unit = "subword"
args.boundary = "end"
doc.name = "word end"
doc.description = "jump forwards to the end of a word"
doc.combined.name = "word/WORD end"
doc.combined.key = "e/shift+e"
doc.combined.description = "jump forwards to the end of a word"

# E (end of WORD)
[[bind]]
default = '{{bind.object_motion}}'
key = "shift+e"
args.unit = "BigWord"
args.boundary = "end"
doc.name = "WORD end"
doc.description = "jump forwards to the end of a word (including punctuation)"
doc.combined.name = "word/WORD end"

# shift+]/shift+[ paragraph
[[bind]]
default = "{{bind.object_motion}}"
key = "shift+]"
args.unit = "paragraph"
args.boundary = "start"
doc.name = "par. →"
doc.description = "jump forwards to the start of a paragraph (contiguous lines)"
doc.combined.name = "paragraph →/←"
doc.combined.key = "shift+]/shift+["
doc.combined.description = "jump forwards/backwards to the start of a paragraph (contiguous lines)"

[[bind]]
default = "{{bind.object_motion}}"
key = "shift+["
args.unit = "paragraph"
args.boundary = "start"
doc.name = "par. ←"
args.value = '{{-1 * max(key.count, 1) * max(val.opCount, 1)}}'
doc.description = "jump backwards to the start of a paragraph (contiguous lines)"
doc.combined.name = "paragraph →/←"
doc.combined.key = "shift+]/shift+["
doc.combined.description = "jump forwards/backwards to the start of a paragraph (contiguous lines)"

# -- Line Motions (0, ^, $, g_, gg, G) --

# 0 (start of line)
[[bind]]
default = '{{bind.motion}}'
key = "0"
command = '{{if item.mode == "normal" { "cursorLineStart" } else { "cursorLineStartSelect" } }}'
doc.name = "line start"
doc.description = "jump to the start of the line"
doc.combined.name = "line start/end"
doc.combined.key = "0/$"
doc.combined.description = "jump to the start/end of the line"

# ^ (first non-blank)
[[bind]]
default = '{{bind.motion}}'
key = "shift+6"
command = '{{if item.mode == "normal" { "cursorHome" } else { "cursorHomeSelect" } }}'
doc.name = "first non-blank"
doc.description = "jump to the first non-blank character of the line"

# $ (end of line)
[[bind]]
default = '{{bind.motion}}'
key = "shift+4"
command = '{{if item.mode == "normal" { "cursorLineEnd" } else { "cursorLineEndSelect" } }}'
doc.name = "line end"
doc.description = "jump to the end of the line"

# gg (start of doc)
[[bind]]
default = '{{bind.motion}}'
key = "g g"
command = '{{if item.mode == "normal" { "cursorTop" } else { "cursorTopSelect" } }}'
doc.name = "doc start"
doc.description = "go to the first line of the document"
doc.combined.name = "doc start/end"
doc.combined.key = "gg/G"
doc.combined.description = "go to the first/last line of the document"

# G (end of doc)
[[bind]]
default = '{{bind.motion}}'
key = "shift+g"
command = '{{if item.mode == "normal" { "cursorBottom" } else { "cursorBottomSelect" } }}'
doc.name = "doc end"
doc.description = "go to the last line of the document"

# -- Find Characters (f, t) --

[[bind]]
key = "f"
default = '{{bind.motion}}'
command = "master-key.search"
args.offset = "fartherBoundary"
args.skip = "{{(max(key.count,1) * max(val.operatorCount, 1))-1}}"
args.selectTillMatch = '{{item.mode != "normal"}}'
args.acceptAfter = 1
doc.name = "find →"
doc.description = "jump to next occurrence of character x"
doc.combined.name = "find →/←"
doc.combined.description = "jump to next/previous occurrence of character x"
doc.combined.key = "f/shift+f"

[[bind]]
key = "shift+f"
default = '{{bind.motion}}'
command = "master-key.search"
args.offset = "fartherBoundary"
args.skip = "{{(max(key.count,1) * max(val.operatorCount, 1))-1}}"
args.reverse = true
args.selectTillMatch = '{{item.mode != "normal"}}'
args.acceptAfter = 1
doc.name = "find ←"
doc.description = "jump to previous occurrence of character x"
doc.combined.name = "find →/←"

[[bind]]
key = "t"
default = '{{bind.motion}}'
command = "master-key.search"
args.offset = "closerBoundary"
args.skip = "{{(max(key.count,1) * max(val.operatorCount, 1))-1}}"
args.selectTillMatch = '{{item.mode != "normal"}}'
args.acceptAfter = 1
doc.name = "to →"
doc.description = "jump to just before the next occurrence of character x"
doc.combined.name = "to →/←"
doc.combined.description = "jump to just before the next/previous occurrence of character x"
doc.combined.key = "t/shift+t"

[[bind]]
key = "shift+t"
default = '{{bind.motion}}'
command = "master-key.search"
args.offset = "closerBoundary"
args.skip = "{{(max(key.count,1) * max(val.operatorCount, 1))-1}}"
args.selectTillMatch = '{{item.mode != "normal"}}'
args.acceptAfter = 1
doc.name = "to ←"
doc.description = "jump to just before the previous occurrence of character x"
doc.combined.name = "to →/←"
doc.combined.description = "jump to just before the next/previous occurrence of character x"
doc.combined.key = "t/shift+t"

# =============================================================================
## ## Text Objects (aw, iw, etc.)
# =============================================================================

[[define.bind]]
id = "object"
mode = 'normal'
prefix.anyOf = ['{{operatorPrefixes}}']
when = "master-key.val.operatorCount > 0"

[[define.bind.after]]
command = "master-key.executeStoredCommand"
args.register = "op"

[[define.bind.after]]
command = "master-key.enterNormal"

[[define.bind.after]]
command = "master-key.setValue"
args.name = "operatorCount"
args.value = 0

# iw (inner word)
[[bind]]
default = '{{bind.object}}'
key = "i w"
command = "selection-utilities.moveBy"
args = { unit = "subword", boundary = "both", select = true }
doc.name = "in word"
doc.description = "operate on entire word"

# aw (around word)
[[bind]]
default = '{{bind.object}}'
key = "a w"
command = "selection-utilities.moveBy"
args = { unit = "subword", boundary = "start", select = true }
doc.name = "around word"
doc.description = "operate on entire word and space"

# iW (inner WORD)
[[bind]]
default = '{{bind.object}}'
key = "i shift+w"
command = "selection-utilities.moveBy"
args = { unit = "paragraph", boundary = "both", select = true }
doc.name = "in WORD"
doc.description = "operate on entire word (including punctuation)"

# aW (around WORD)
[[bind]]
default = '{{bind.object}}'
key = "a shift+w"
command = "selection-utilities.moveBy"
args = { unit = "paragraph", boundary = "start", select = true }
doc.name = "ard WORD"
doc.description = "operate around entire word (including punctuation)"

# ip (inner paragraph)
[[bind]]
default = '{{bind.object}}'
key = "i p"
command = "selection-utilities.moveBy"
args = { unit = "paragraph", boundary = "both", select = true }
doc.name = "in paragraph"
doc.description = "operate on entire paragraph"

# ap (around paragraph)
[[bind]]
default = '{{bind.object}}'
key = "a p"
command = "selection-utilities.moveBy"
args = { unit = "paragraph", boundary = "start", select = true }
doc.name = "around paragraph"
doc.description = "operate on entire paragraph and spacing"

# =============================================================================
## ## Counts (0-9)
# =============================================================================

# Counts can be prefixed to commands to repeat them the given number of times.
# e.g. `9dj` deletes 9 lines

[[bind]]
foreach.num = ['{{keys(`[1-9]`)}}']
key = "{{num}}"
mode = '{{all_modes()}}'
command = "master-key.updateCount"
finalKey = false
args.value = "{{num}}"
doc.name = "count {{num}}"
doc.description = "Add digit {{num}} to the count argument of a command"
doc.combined.key = "0-9"
doc.combined.name = "count 0-9"
doc.combined.description = "Add digit 0-9 to count argument of a command"

# 0 means go to the start of the line *unless* we have already entered a count and then its
# used to update the count
[[bind]]
key = "0"
mode = '{{all_modes()}}'
command = "master-key.updateCount"
when = "master-key.count > 0"
finalKey = false
args.value = "0"
doc.name = "count 0"
doc.description = "Add digit 0 to the count argument of a command"
doc.combined.key = "0-9"
doc.combined.name = "count 0-9"
doc.combined.description = "Add digit 0-9 to count argument of a command"

# =============================================================================
## ## Insert Mode
# =============================================================================

[[bind]]
key = "i"
mode = "normal"
command = "master-key.enterInsert"
doc.name = "insert"
doc.description = "insert before the cursor"
doc.combined.name = "insert start/line"
doc.combined.key = "i/I"
doc.combined.description = "insert before the cursor / at the beginning of the line"


[[bind]]
key = "shift+i"
mode = "normal"
command = "runCommands"
args.commands = ["cursorLineStart", "master-key.enterInsert"]
doc.name = "insert start"
doc.description = "insert at the beginning of the line"

[[bind]]
key = "a"
mode = "normal"
command = "runCommands"
args.commands = ["cursorRight", "master-key.enterInsert"]
doc.name = "append"
doc.description = "insert (append) after the cursor"
doc.combined.name = "append end/line"
doc.combined.key = "a/A"
doc.combined.description = "insert (append) after the cursor / at the end of the line"


[[bind]]
key = "shift+a"
mode = "normal"
command = "runCommands"
args.commands = ["cursorLineEnd", "master-key.enterInsert"]
doc.name = "append end"
doc.description = "insert (append) at the end of the line"

[[bind]]
key = "o"
mode = "normal"
command = "runCommands"
args.commands = ["editor.action.insertLineAfter", "master-key.enterInsert"]
doc.name = "open below"
doc.description = "append (open) a new line below the current line"
doc.combined.name = "open below/above"
doc.combined.key = "o/O"
doc.combined.description = "append (open) a new line below/above the current line"

[[bind]]
key = "shift+o"
mode = "normal"
command = "runCommands"
args.commands = ["editor.action.insertLineBefore", "master-key.enterInsert"]
doc.name = "open above"
doc.description = "append (open) a new line above the current line"

# =============================================================================
## ## Editing / Operators
# =============================================================================

# d (Delete / Cut)
[[bind]]
key = "d"
mode = "normal"
command = "runCommands"
args.commands = [
    { command = "master-key.setValue", args = { name = "operatorCount", value = "{{max(key.count, 1)}}" } },
    { command = "master-key.storeCommand", args = { register = "op", command = "editor.action.clipboardCutAction" } },
    { command = "master-key.prefix", args = { cursor = "Underline" } },
]
doc.name = "delete"
doc.description = "delete marked text"

[[bind]]
key = "d"
mode = "visual"
command = "runCommands"
args.commands = [
    "editor.action.clipboardCutAction",
    { command = "master-key.setMode", args = { value = "normal" } },
]
doc.name = "delete"
doc.description = "delete marked text"

# dd (Delete line)
[[bind]]
key = "d"
prefixes.anyOf = "d"
mode = "normal"
command = "runCommands"
args.commands = [
    "selection-utilities.shrinkToActive",
    "expandLineSelection",
    # Execute op (cut)
    "master-key.executeStoredCommand",
]
doc.name = "delete line"
doc.description = "delete (cut) a line"

# y (Yank / Copy)
[[bind]]
key = "y"
mode = "normal"
command = "runCommands"
args.commands = [
    { command = "master-key.setValue", args = { name = "operatorCount", value = "{{max(key.count, 1)}}" } },
    { command = "master-key.storeCommand", args = { register = "op", command = "editor.action.clipboardCopyAction" } },
    { command = "master-key.prefix", args = { cursor = "Underline" } },
]
doc.name = "yank"
doc.description = "yank (copy) marked text"

[[bind]]
key = "y"
mode = "visual"
command = "runCommands"
args.commands = [
    "editor.action.clipboardCopyAction",
    { command = "master-key.setMode", args = { value = "normal" } },
]
doc.name = "yank"
doc.description = "yank (copy) marked text"

# yy (Yank line)
[[bind]]
key = "y"
prefixes.anyOf = "y"
mode = "normal"
command = "runCommands"
args.commands = [
    "selection-utilities.shrinkToActive",
    "expandLineSelection",
    "master-key.executeStoredCommand",
]
doc.name = "yank line"
doc.description = "yank (copy) a line"

# c (Change)
[[bind]]
key = "c"
mode = "normal"
command = "runCommands"
args.commands = [
    { command = "master-key.setValue", args = { name = "operatorCount", value = "{{max(key.count, 1)}}" } },
    { command = "master-key.storeCommand", args = { register = "op", command = "runCommands", args = { commands = [
        "editor.action.clipboardCutAction",
        "master-key.enterInsert",
    ] } } },
    { command = "master-key.prefix", args = { cursor = "Underline" } },
]
doc.name = "change"
doc.description = "change"

# cc (Change line)
[[bind]]
key = "c"
prefixes.anyOf = "c"
mode = "normal"
command = "runCommands"
args.commands = [
    "selection-utilities.shrinkToActive",
    "expandLineSelection",
    "editor.action.clipboardCutAction",
]
doc.name = "change line"
doc.description = "change (replace) entire line"

# x (delete char)
[[bind]]
key = "x"
mode = "normal"
command = "runCommands"
args.commands = [
    { command = "cursorMove", args = { to = "right", select = true, value = "{{max(key.count, 1)}}" } },
    "editor.action.clipboardCutAction",
]
doc.name = "del char"
doc.description = "delete (cut) character"

# p (paste)
[[bind]]
key = "p"
mode = "normal"
command = "editor.action.clipboardPasteAction"
doc.name = "paste"
doc.description = "put (paste) the clipboard after cursor"

# u (undo)
[[bind]]
key = "u"
mode = "normal"
command = "undo"
doc.name = "undo"
doc.description = "undo"

# Ctrl+r (redo)
[[bind]]
key = "ctrl+r"
mode = "normal"
command = "redo"
doc.name = "redo"
doc.description = "redo"

# =============================================================================
## ## Visual Mode
# =============================================================================

[[bind]]
key = "v"
mode = "normal"
command = "master-key.setMode"
args.value = "visual"
doc.name = "visual"
doc.description = "start visual mode"

# =============================================================================
## ## Search
# =============================================================================

[[bind]]
key = "/"
mode = "normal"
command = "master-key.search"
args = { offset = "start", selectTillMatch = '{{key.mode != "normal"}}' }
doc.name = "search"
doc.description = "search for pattern"

[[bind]]
key = "n"
mode = "normal"
command = "master-key.nextMatch"
doc.name = "next"
doc.description = "repeat search in same direction"
doc.combined.name = "next/prev match"
doc.combined.key = "n/N"
doc.combined.description = "repeat search in same/opposite direction"

[[bind]]
key = "shift+n"
mode = "normal"
command = "master-key.previousMatch"
doc.name = "previous"
doc.description = "repeat search in opposite direction"

# =============================================================================
## ## Window Commands (Ctrl+w)
# =============================================================================

[[bind]]
key = "g h"
mode = "normal"
command = "editor.action.showHover"
doc.name = "hover"
doc.description = "open hover for word under the cursor"

[[bind]]
key = "ctrl+w s"
mode = "normal"
command = "workbench.action.splitEditorDown"
doc.name = "split window"
doc.description = "split window"

[[bind]]
key = "ctrl+w v"
mode = "normal"
command = "workbench.action.splitEditorRight"
doc.name = "split vertical"
doc.description = "split window vertically"

[[bind]]
key = "ctrl+w w"
mode = "normal"
command = "workbench.action.navigateEditorGroups"
doc.name = "switch window"
doc.description = "switch windows"

[[bind]]
key = "ctrl+w q"
mode = "normal"
command = "workbench.action.closeActiveEditor"
doc.name = "quit window"
doc.description = "quit a window"

[[bind]]
key = "ctrl+w h"
mode = "normal"
command = "workbench.action.navigateLeft"
doc.name = "window left"
doc.description = "move cursor to the left window (vertical split)"
doc.combined.name = "window left/right/down/up"
doc.combined.key = "h/l/j/k"
doc.combined.description = "move cursor to the window left/right/down/up"

[[bind]]
key = "ctrl+w l"
mode = "normal"
command = "workbench.action.navigateRight"
doc.name = "window right"
doc.description = "move cursor to the right window (vertical split)"
doc.combined.name = "window left/right/down/up"

[[bind]]
key = "ctrl+w j"
mode = "normal"
command = "workbench.action.navigateDown"
doc.name = "window down"
doc.description = "move cursor to the window below (horizontal split)"
doc.combined.name = "window left/right/down/up"

[[bind]]
key = "ctrl+w k"
mode = "normal"
command = "workbench.action.navigateUp"
doc.name = "window up"
doc.description = "move cursor to the window above (horizontal split)"
doc.combined.name = "window left/right/down/up"

[[bind]]
key = "ctrl+w ="
mode = "normal"
command = "workbench.action.evenEditorWidths"
doc.name = "equalize"
doc.combined.name = "window left/right/down/up"
doc.description = "make all windows equal height & width"
